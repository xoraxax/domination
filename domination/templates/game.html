{% extends "base.html" %}
{% block title %}Game: {{ game.name }}{% endblock %}
{% block head %}
  {{ super() }}
  {% if not req %}
  <script type="text/javascript">
    var initial_seqno = {{ seqno | tojson | safe }};
    var game_name = {{ runner.game.name | tojson | safe }};
    $(handle_page_refresh);
  </script>
  {% endif %}
  <script type="text/javascript">
    $(function() {
        $.scrollTo("#game");
    });
  </script>
  {{ macros.init_render_card() }}
{% endblock %}
{% block content %}
<a id="game"></a>
<h2>Game: {{ game.name }}{% if runner.startable(runner.owner) %} (stopped){% endif %}</h2>
  <ul>
    {% if game not in store.games %}
      <li><a href="{{ url_for("join_game", name=game.name) }}">Join</a></li>
    {% endif %}
    {% if runner.startable(store.games[game]) %}
    <li><a href="{{ url_for("start_game", name=game.name) }}">Start</a></li>
    {% endif %}
  </ul>
  <h3>Players</h3>
  <ul>
    {% for player in game.players %}
    <li class="{% if player.current %}activeplayer{% endif %}">{{ player.name }} ({{ player.hand | count }} of {{ (player.hand + player.deck + player.discard_pile) | count }} cards in hand)
    {% if runner.waiting_for == player %} (waiting for this player){% endif %}
    </li>
    {% endfor %}
  </ul>
  {% if player.info_queue %}
  <ul>
    {% for req in player.info_queue %}
      <li class="infoitem">
        <h3>{{ req.msg }}</h3>
        {% if req.req_type == "EndOfGameRequest" %}
          <ul>
          {% for player in game.players %}
            <li>{{ player.name }}: {{ player.deck | count }} cards, {{ player.points(game) }} points</li>
          {% endfor %}
          </ul>
          Your cards:
          {% for card in req.cards %}
            {{ macros.render_card(card) }}  
          {% endfor %}
        {% else %}
          {% for card in req.cards %}
            {{ macros.render_card(card) }}  
          {% endfor %}
        {% endif %}
      </li>
    {% endfor %}
  </ul>
  {% endif %}
  {% if req %}
    <h3>{{ req.msg }}</h3>
    {% if req.last_error %}
      <div class="errormessage">{{ req.last_error }}</div>
    {% endif %}
    {% if req_type == "SelectDeal" %}
      <p>You have {{ player.remaining_money }} Money remaining!</p>
      {% for card in req.cards %}
        {% call macros.render_card(card) %}
          {{ game.supply[card.__name__] | count }} left
          {% if req.is_buyable(card) %}
            <form action="" method="post">
              <input type="hidden" name="req_id" value="{{ req_id }}">
              <input type="hidden" name="card" value="{{ card.__name__ }}">
              <input type="submit" value="Buy">
            </form>
          {% endif %}
        {% endcall %}
      {% endfor %}
      <form action="" method="post">
      <input type="hidden" name="req_id" value="{{ req_id }}">
      <input type="submit" value="Cancel">
      </form>
    {% elif req_type == "SelectHandCards" %}
      {% if req.count_upper != 1 and req.count_upper != none %}
        You may select at most {{ req.count_upper }} cards.
      {% endif %}
      {% if not req.count_lower in (0, 1) %}
        You need to select at least {{ req.count_lower }} cards.
      {% endif %}
      {% if req.count_upper != 1 %}
        <form action="" method="post">
          <input type="hidden" name="req_id" value="{{ req_id }}">
      {% endif %}
      {% for card in player.sorted_hand %}
        {% call macros.render_card(card) %}
          {% if req.is_selectable(card) %}
            {% if req.count_upper == 1 %}
              <form action="" method="post">
              <input type="hidden" name="req_id" value="{{ req_id }}">
              <input type="hidden" name="card" value="{{ loop.index0 }}">
              <input type="submit" value="Select">
              {% if req.count_lower == 0 %}
                <input type="submit" name="canceled" value="Cancel">
              {% endif %}
              </form>
            {% else %}
              <input type="checkbox" name="card" value="{{ loop.index0 }}">
            {% endif %}
          {% endif %}
        {% endcall %}
      {% endfor %}
      {% if req.count_upper != 1 %}
          <input type="submit" value="Select">
        </form>
      {% endif %}
    {% elif req_type == "SelectCard" %}
      {% for card in req.card_classes %}
        {% call macros.render_card(card) %}
          <form action="" method="post">
            <input type="hidden" name="req_id" value="{{ req_id }}">
            <input type="hidden" name="card" value="{{ card.__name__ }}">
            <input type="submit" value="Select">
          </form>
        {% endcall %}
      {% endfor %}
    {% elif req_type == "YesNoQuestion" %}
      <form action="" method="post">
        <input type="hidden" name="req_id" value="{{ req_id }}">
        <input type="hidden" name="answer" value="yes">
        <input type="submit" value="Yes">
      </form>
      <form action="" method="post">
        <input type="hidden" name="req_id" value="{{ req_id }}">
        <input type="hidden" name="answer" value="no">
        <input type="submit" value="No">
      </form>
    {% else %}
      Unknown request {{ req | string }}!
    {% endif %}
  {% endif %}
  {% if player %}
    {% if not player.deck and not player.hand %}
      {% if game.players | count == 1 %}
        Waiting for further players ...
      {% else %}
        Waiting for {{ runner.owner.name }} to start the game ...
      {% endif %}
    {% else %}
      {% if req_type != "SelectHandCards" %}
        <h3>Your hand</h3>
        {% for card in player.sorted_hand %}
          {{ macros.render_card(card) }}  
        {% endfor %}
      {% endif %}
      <h3>Your deck</h3>
      {{ player.deck | count }} cards
      {% if player.activated_cards %}
        <h3>Activated action cards</h3>
        {% for card in player.activated_cards %}
          {{ macros.render_card(card) }}  
        {% endfor %}
      {% endif %}
      <h3>Your discard pile</h3>
      {{ player.discard_pile | count }} cards
    {% endif %}
  {% endif %}
{% endblock %}
